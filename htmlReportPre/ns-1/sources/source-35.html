


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=windows-1252"> 
  <title>Coverage Report > ValidatingVisitor</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.everit.json.schema</a>
</div>

<h1>Coverage Summary for Class: ValidatingVisitor (org.everit.json.schema)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ValidatingVisitor</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    96.3%
  </span>
  <span class="absValue">
    (26/27)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    90%
  </span>
  <span class="absValue">
    (54/60)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    98.9%
  </span>
  <span class="absValue">
    (93/94)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package org.everit.json.schema;
&nbsp;
&nbsp;import static java.lang.String.format;
&nbsp;import static java.util.Arrays.asList;
&nbsp;import static java.util.Collections.unmodifiableList;
&nbsp;import static java.util.Objects.requireNonNull;
&nbsp;import static java.util.stream.Collectors.joining;
&nbsp;import static org.everit.json.schema.EnumSchema.toJavaValue;
&nbsp;import static org.everit.json.schema.PrimitiveValidationStrategy.LENIENT;
&nbsp;import static org.everit.json.schema.StringToValueConverter.stringToValue;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Collection;
&nbsp;import java.util.List;
&nbsp;import java.util.function.Consumer;
&nbsp;import java.util.function.Function;
&nbsp;
&nbsp;import org.everit.json.schema.event.CombinedSchemaMatchEvent;
&nbsp;import org.everit.json.schema.event.CombinedSchemaMismatchEvent;
&nbsp;import org.everit.json.schema.event.SchemaReferencedEvent;
&nbsp;import org.everit.json.schema.event.ValidationListener;
&nbsp;import org.json.JSONArray;
&nbsp;import org.json.JSONObject;
&nbsp;
&nbsp;class ValidatingVisitor extends Visitor {
&nbsp;
<b class="fc">&nbsp;    private static final List&lt;Class&lt;?&gt;&gt; VALIDATED_TYPES = unmodifiableList(asList(</b>
&nbsp;            Number.class,
&nbsp;            String.class,
&nbsp;            Boolean.class,
&nbsp;            JSONObject.class,
&nbsp;            JSONArray.class,
<b class="fc">&nbsp;            JSONObject.NULL.getClass()</b>
&nbsp;    ));
&nbsp;
<b class="fc">&nbsp;    static final String TYPE_FAILURE_MSG = &quot;subject is an instance of non-handled type %s. Should be one of &quot;</b>
<b class="fc">&nbsp;            + VALIDATED_TYPES.stream().map(Class::getSimpleName).collect(joining(&quot;, &quot;));</b>
&nbsp;
&nbsp;    private static boolean isNull(Object obj) {
<b class="fc">&nbsp;        return obj == null || JSONObject.NULL.equals(obj);</b>
&nbsp;    }
&nbsp;
&nbsp;    protected Object subject;
&nbsp;
&nbsp;    final ValidationListener validationListener;
&nbsp;
&nbsp;    private ValidationFailureReporter failureReporter;
&nbsp;
&nbsp;    private final ReadWriteValidator readWriteValidator;
&nbsp;
&nbsp;    private final PrimitiveValidationStrategy primitiveValidationStrategy;
&nbsp;
&nbsp;    @Override
&nbsp;    void visit(Schema schema) {
<b class="fc">&nbsp;        if (Boolean.FALSE.equals(schema.isNullable()) &amp;&amp; isNull(subject)) {</b>
<b class="fc">&nbsp;            failureReporter.failure(&quot;value cannot be null&quot;, &quot;nullable&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        readWriteValidator.validate(schema, subject);</b>
<b class="fc">&nbsp;        super.visit(schema);</b>
&nbsp;    }
&nbsp;
&nbsp;    ValidatingVisitor(Object subject, ValidationFailureReporter failureReporter, ReadWriteValidator readWriteValidator,
&nbsp;                      ValidationListener validationListener,
<b class="fc">&nbsp;                      PrimitiveValidationStrategy primitiveValidationStrategy) {</b>
<b class="fc">&nbsp;        if (subject != null &amp;&amp; !VALIDATED_TYPES.stream().anyMatch(type -&gt; type.isAssignableFrom(subject.getClass()))) {</b>
<b class="fc">&nbsp;            throw new IllegalArgumentException(format(TYPE_FAILURE_MSG, subject.getClass().getSimpleName()));</b>
&nbsp;        }
<b class="fc">&nbsp;        this.subject = subject;</b>
<b class="fc">&nbsp;        this.failureReporter = failureReporter;</b>
<b class="fc">&nbsp;        this.readWriteValidator = readWriteValidator;</b>
<b class="fc">&nbsp;        this.validationListener = validationListener;</b>
<b class="fc">&nbsp;        this.primitiveValidationStrategy = requireNonNull(primitiveValidationStrategy);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    void visitNumberSchema(NumberSchema numberSchema) {
<b class="fc">&nbsp;        numberSchema.accept(new NumberSchemaValidatingVisitor(subject, this));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    void visitArraySchema(ArraySchema arraySchema) {
<b class="fc">&nbsp;        arraySchema.accept(new ArraySchemaValidatingVisitor(this));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    void visitBooleanSchema(BooleanSchema schema) {
<b class="fc">&nbsp;        ifPassesTypeCheck(Boolean.class, true, schema.isNullable(), v -&gt; {});</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    void visitNullSchema(NullSchema nullSchema) {
<b class="pc">&nbsp;        if (!(isNull(subject) || (primitiveValidationStrategy == LENIENT &amp;&amp; &quot;null&quot;.equals(subject)))) {</b>
<b class="fc">&nbsp;            failureReporter.failure(&quot;expected: null, found: &quot; + subject.getClass().getSimpleName(), &quot;type&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    void visitConstSchema(ConstSchema constSchema) {
<b class="pc">&nbsp;        if (isNull(subject) &amp;&amp; isNull(constSchema.getPermittedValue())) {</b>
&nbsp;            return;
&nbsp;        }
<b class="fc">&nbsp;        Object effectiveSubject = toJavaValue(subject);</b>
<b class="fc">&nbsp;        if (!ObjectComparator.deepEquals(effectiveSubject, constSchema.getPermittedValue())) {</b>
<b class="fc">&nbsp;            failureReporter.failure(&quot;&quot;, &quot;const&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    void visitEnumSchema(EnumSchema enumSchema) {
<b class="fc">&nbsp;        Object effectiveSubject = toJavaValue(subject);</b>
<b class="fc">&nbsp;        for (Object possibleValue : enumSchema.getPossibleValues()) {</b>
<b class="fc">&nbsp;            if (ObjectComparator.deepEquals(possibleValue, effectiveSubject)) {</b>
&nbsp;                return;
&nbsp;            }
<b class="fc">&nbsp;        }</b>
<b class="fc">&nbsp;        failureReporter.failure(format(&quot;%s is not a valid enum value&quot;, subject), &quot;enum&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    void visitFalseSchema(FalseSchema falseSchema) {
<b class="fc">&nbsp;        failureReporter.failure(&quot;false schema always fails&quot;, &quot;false&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    void visitNotSchema(NotSchema notSchema) {
<b class="fc">&nbsp;        Schema mustNotMatch = notSchema.getMustNotMatch();</b>
<b class="fc">&nbsp;        ValidationException failure = getFailureOfSchema(mustNotMatch, subject);</b>
<b class="fc">&nbsp;        if (failure == null) {</b>
<b class="fc">&nbsp;            failureReporter.failure(&quot;subject must not be valid against schema &quot; + mustNotMatch, &quot;not&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    void visitReferenceSchema(ReferenceSchema referenceSchema) {
<b class="fc">&nbsp;        Schema referredSchema = referenceSchema.getReferredSchema();</b>
<b class="fc">&nbsp;        if (referredSchema == null) {</b>
<b class="fc">&nbsp;            throw new IllegalStateException(&quot;referredSchema must be injected before validation&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        ValidationException failure = getFailureOfSchema(referredSchema, subject);</b>
<b class="fc">&nbsp;        if (failure != null) {</b>
<b class="fc">&nbsp;            failureReporter.failure(failure);</b>
&nbsp;        }
<b class="pc">&nbsp;        if (validationListener != null) {</b>
<b class="fc">&nbsp;            validationListener.schemaReferenced(new SchemaReferencedEvent(referenceSchema, subject, referredSchema));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    void visitObjectSchema(ObjectSchema objectSchema) {
<b class="fc">&nbsp;        objectSchema.accept(new ObjectSchemaValidatingVisitor(this));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    void visitStringSchema(StringSchema stringSchema) {
<b class="fc">&nbsp;        stringSchema.accept(new StringSchemaValidatingVisitor(subject, this));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    void visitCombinedSchema(CombinedSchema combinedSchema) {
<b class="fc">&nbsp;        Collection&lt;Schema&gt; subschemas = combinedSchema.getSubschemas();</b>
<b class="fc">&nbsp;        List&lt;ValidationException&gt; failures = new ArrayList&lt;&gt;(subschemas.size());</b>
<b class="fc">&nbsp;        CombinedSchema.ValidationCriterion criterion = combinedSchema.getCriterion();</b>
<b class="fc">&nbsp;        for (Schema subschema : subschemas) {</b>
<b class="fc">&nbsp;            ValidationException exception = getFailureOfSchema(subschema, subject);</b>
<b class="fc">&nbsp;            if (null != exception) {</b>
<b class="fc">&nbsp;                failures.add(exception);</b>
&nbsp;            }
<b class="fc">&nbsp;            reportSchemaMatchEvent(combinedSchema, subschema, exception);</b>
<b class="fc">&nbsp;        }</b>
<b class="fc">&nbsp;        int matchingCount = subschemas.size() - failures.size();</b>
&nbsp;        try {
<b class="fc">&nbsp;            criterion.validate(subschemas.size(), matchingCount);</b>
<b class="fc">&nbsp;        } catch (ValidationException e) {</b>
<b class="fc">&nbsp;            failureReporter.failure(new InternalValidationException(combinedSchema,</b>
<b class="fc">&nbsp;                    new StringBuilder(e.getPointerToViolation()),</b>
<b class="fc">&nbsp;                    e.getMessage(),</b>
&nbsp;                    failures,
<b class="fc">&nbsp;                    e.getKeyword(),</b>
<b class="fc">&nbsp;                    combinedSchema.getSchemaLocation()));</b>
<b class="fc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    void visitConditionalSchema(ConditionalSchema conditionalSchema) {
<b class="fc">&nbsp;        conditionalSchema.accept(new ConditionalSchemaValidatingVisitor(subject, this));</b>
&nbsp;    }
&nbsp;
&nbsp;    private void reportSchemaMatchEvent(CombinedSchema schema, Schema subschema, ValidationException failure) {
<b class="fc">&nbsp;        if (failure == null) {</b>
<b class="fc">&nbsp;            validationListener.combinedSchemaMatch(new CombinedSchemaMatchEvent(schema, subschema, subject));</b>
&nbsp;        } else {
<b class="fc">&nbsp;            validationListener.combinedSchemaMismatch(new CombinedSchemaMismatchEvent(schema, subschema, subject, failure));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    ValidationException getFailureOfSchema(Schema schema, Object input) {
<b class="fc">&nbsp;        Object origSubject = this.subject;</b>
<b class="fc">&nbsp;        this.subject = input;</b>
<b class="fc">&nbsp;        ValidationException rval = failureReporter.inContextOfSchema(schema, () -&gt; visit(schema));</b>
<b class="fc">&nbsp;        this.subject = origSubject;</b>
<b class="fc">&nbsp;        return rval;</b>
&nbsp;    }
&nbsp;
&nbsp;    void failIfErrorFound() {
<b class="fc">&nbsp;        failureReporter.validationFinished();</b>
&nbsp;    }
&nbsp;
&nbsp;    void failure(String message, String keyword) {
<b class="fc">&nbsp;        failureReporter.failure(message, keyword);</b>
&nbsp;    }
&nbsp;
&nbsp;    void failure(Class&lt;?&gt; expectedType, Object actualValue) {
<b class="nc">&nbsp;        failureReporter.failure(expectedType, actualValue);</b>
&nbsp;    }
&nbsp;
&nbsp;    void failure(ValidationException exc) {
<b class="fc">&nbsp;        failureReporter.failure(exc);</b>
&nbsp;    }
&nbsp;
&nbsp;    Object getFailureState() {
<b class="fc">&nbsp;        return failureReporter.getState();</b>
&nbsp;    }
&nbsp;
&nbsp;    boolean isFailureStateChanged(Object olState) {
<b class="fc">&nbsp;        return failureReporter.isChanged(olState);</b>
&nbsp;    }
&nbsp;
&nbsp;    &lt;SE, E extends SE&gt; void ifPassesTypeCheck(Class&lt;E&gt; expectedType, Function&lt;Object, SE&gt; castFn, boolean schemaRequiresType, Boolean nullable,
&nbsp;                                              Consumer&lt;SE&gt; onPass) {
<b class="fc">&nbsp;        Object subject = this.subject;</b>
<b class="fc">&nbsp;        if (primitiveValidationStrategy == LENIENT) {</b>
<b class="fc">&nbsp;            boolean expectedString = expectedType.isAssignableFrom(String.class);</b>
<b class="fc">&nbsp;            if (subject instanceof String &amp;&amp; !expectedString) {</b>
<b class="fc">&nbsp;                subject = stringToValue((String) subject);</b>
<b class="pc">&nbsp;            } else if (expectedString) {</b>
<b class="fc">&nbsp;                subject = subject.toString();</b>
&nbsp;            }
&nbsp;        }
<b class="fc">&nbsp;        if (isNull(subject)) {</b>
<b class="fc">&nbsp;            if (schemaRequiresType &amp;&amp; !Boolean.TRUE.equals(nullable)) {</b>
<b class="fc">&nbsp;                failureReporter.failure(expectedType, this.subject);</b>
&nbsp;            }
&nbsp;            return;
&nbsp;        }
<b class="fc">&nbsp;        if (TypeChecker.isAssignableFrom(expectedType, subject.getClass())) {</b>
<b class="fc">&nbsp;            onPass.accept(castFn.apply(subject));</b>
&nbsp;            return;
&nbsp;        }
<b class="fc">&nbsp;        if (schemaRequiresType) {</b>
<b class="fc">&nbsp;            failureReporter.failure(expectedType, this.subject);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    &lt;E&gt; void ifPassesTypeCheck(Class&lt;E&gt; expectedType, boolean schemaRequiresType, Boolean nullable,
&nbsp;                               Consumer&lt;E&gt; onPass) {
<b class="fc">&nbsp;        ifPassesTypeCheck(expectedType, expectedType::cast, schemaRequiresType, nullable, onPass);</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-11-01 17:20</div>
</div>
</body>
</html>
