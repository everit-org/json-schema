


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=windows-1252"> 
  <title>Coverage Report > IssueTest</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.everit.json.schema</a>
</div>

<h1>Coverage Summary for Class: IssueTest (org.everit.json.schema)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">IssueTest</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/23)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/46)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/125)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package org.everit.json.schema;
&nbsp;
&nbsp;import static java.util.Arrays.asList;
&nbsp;import static java.util.Objects.requireNonNull;
&nbsp;import static org.everit.json.schema.loader.OrgJsonUtil.toMap;
&nbsp;import static org.junit.jupiter.api.Assertions.fail;
&nbsp;
&nbsp;import java.io.IOException;
&nbsp;import java.io.InputStream;
&nbsp;import java.io.UncheckedIOException;
&nbsp;import java.lang.reflect.Constructor;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Comparator;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Objects;
&nbsp;import java.util.Optional;
&nbsp;import java.util.Set;
&nbsp;import java.util.function.Consumer;
&nbsp;import java.util.regex.Pattern;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import org.apache.commons.io.IOUtils;
&nbsp;import org.everit.json.schema.loader.SchemaClient;
&nbsp;import org.everit.json.schema.loader.SchemaLoader;
&nbsp;import org.everit.json.schema.regexp.RE2JRegexpFactory;
&nbsp;import org.json.JSONArray;
&nbsp;import org.json.JSONException;
&nbsp;import org.json.JSONObject;
&nbsp;import org.json.JSONTokener;
&nbsp;import org.junit.jupiter.api.Assumptions;
&nbsp;import org.junit.jupiter.params.ParameterizedTest;
&nbsp;import org.junit.jupiter.params.provider.Arguments;
&nbsp;import org.junit.jupiter.params.provider.MethodSource;
&nbsp;import org.reflections.Reflections;
&nbsp;import org.reflections.scanners.ResourcesScanner;
&nbsp;
<b class="nc">&nbsp;public class IssueTest {</b>
&nbsp;
&nbsp;    public static List&lt;Arguments&gt; params() {
<b class="nc">&nbsp;        List&lt;Arguments&gt; rval = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        Reflections refs = new Reflections(&quot;org.everit.json.schema.issues&quot;,</b>
&nbsp;                new ResourcesScanner());
<b class="nc">&nbsp;        Set&lt;String&gt; paths = refs.getResources(Pattern.compile(&quot;schema.json&quot;))</b>
<b class="nc">&nbsp;                .stream().map(path -&gt; path.substring(0, path.lastIndexOf(&#39;/&#39;)))</b>
<b class="nc">&nbsp;                .collect(Collectors.toSet());</b>
<b class="nc">&nbsp;        for (String path : paths) {</b>
<b class="nc">&nbsp;            rval.add(Arguments.of(path, path.substring(path.lastIndexOf(&#39;/&#39;) + 1)));</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return rval;</b>
&nbsp;    }
&nbsp;
&nbsp;    private String issueDir;
&nbsp;
&nbsp;    private JettyWrapper servletSupport;
&nbsp;
&nbsp;    private SchemaLoader.SchemaLoaderBuilder loaderBuilder;
&nbsp;
<b class="nc">&nbsp;    private final Validator.ValidatorBuilder validatorBuilder = Validator.builder();</b>
&nbsp;
&nbsp;    private Optional&lt;InputStream&gt; fileByName(final String fileName) {
<b class="nc">&nbsp;        return Optional.ofNullable(getClass().getResourceAsStream(issueDir + &quot;/&quot; + fileName));</b>
&nbsp;    }
&nbsp;
&nbsp;    private void initJetty() {
&nbsp;        try {
<b class="nc">&nbsp;            servletSupport = new JettyWrapper(issueDir + &quot;/&quot; + &quot;remotes&quot;);</b>
<b class="nc">&nbsp;            servletSupport.start();</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(e);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    private static JSONObject streamAsJson(InputStream file) {
&nbsp;        try {
<b class="nc">&nbsp;            return new JSONObject(new JSONTokener(IOUtils.toString(file)));</b>
<b class="nc">&nbsp;        } catch (java.io.IOException e) {</b>
<b class="nc">&nbsp;            throw new UncheckedIOException(e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private Schema loadSchema() {
<b class="nc">&nbsp;        Optional&lt;InputStream&gt; schemaFile = fileByName(&quot;schema.json&quot;);</b>
<b class="nc">&nbsp;        if (schemaFile.isPresent()) {</b>
<b class="nc">&nbsp;            JSONObject schemaObj = streamAsJson(schemaFile.get());</b>
<b class="nc">&nbsp;            loaderBuilder = SchemaLoader.builder().schemaJson(schemaObj);</b>
<b class="nc">&nbsp;            consumeValidatorConfig();</b>
<b class="nc">&nbsp;            return loaderBuilder.build().load().build();</b>
&nbsp;        }
<b class="nc">&nbsp;        throw new RuntimeException(issueDir + &quot;/schema.json is not found&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void consumeValidatorConfig() {
<b class="nc">&nbsp;        Map&lt;String, Consumer&lt;Object&gt;&gt; configKeyHandlers = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        configKeyHandlers.put(&quot;failEarly&quot;, value -&gt; {</b>
<b class="nc">&nbsp;            if (Boolean.TRUE.equals(value)) {</b>
<b class="nc">&nbsp;                validatorBuilder.failEarly();</b>
&nbsp;            }
&nbsp;        });
<b class="nc">&nbsp;        configKeyHandlers.put(&quot;resolutionScope&quot;, value -&gt; loaderBuilder.resolutionScope((String) value));</b>
<b class="nc">&nbsp;        configKeyHandlers.put(&quot;regexpImplementation&quot;, value -&gt; {</b>
<b class="nc">&nbsp;            if (Objects.equals(&quot;RE2J&quot;, value)) {</b>
<b class="nc">&nbsp;                loaderBuilder.regexpFactory(new RE2JRegexpFactory());</b>
&nbsp;            }
&nbsp;        });
<b class="nc">&nbsp;        configKeyHandlers.put(&quot;customFormats&quot;, value -&gt; {</b>
<b class="nc">&nbsp;            JSONObject json = (JSONObject) value;</b>
<b class="nc">&nbsp;            toMap(json).entrySet()</b>
<b class="nc">&nbsp;                    .forEach(entry -&gt; loaderBuilder</b>
<b class="nc">&nbsp;                            .addFormatValidator(entry.getKey(), this.createFormatValidator(entry)));</b>
&nbsp;        });
<b class="nc">&nbsp;        configKeyHandlers.put(&quot;metaSchemaVersion&quot;, value -&gt; {</b>
<b class="nc">&nbsp;            int versionNo = (Integer) value;</b>
<b class="nc">&nbsp;            if (!asList(4, 6, 7).contains(versionNo)) {</b>
<b class="nc">&nbsp;                throw new IllegalArgumentException(</b>
&nbsp;                        &quot;invalid metaSchemaVersion in validator-config.json: should be one of 4, 6, or 7, found: &quot; + versionNo);
&nbsp;            }
<b class="nc">&nbsp;            if (versionNo == 6) {</b>
<b class="nc">&nbsp;                loaderBuilder.draftV6Support();</b>
<b class="nc">&nbsp;            } else if (versionNo == 7) {</b>
<b class="nc">&nbsp;                loaderBuilder.draftV7Support();</b>
&nbsp;            }
&nbsp;        });
<b class="nc">&nbsp;        configKeyHandlers.put(&quot;schemaClient&quot;, value -&gt; {</b>
<b class="nc">&nbsp;            if (&quot;classPathAware&quot;.equals(value)) {</b>
<b class="nc">&nbsp;                loaderBuilder.schemaClient(SchemaClient.classPathAwareClient());</b>
&nbsp;            }
&nbsp;        });
<b class="nc">&nbsp;        configKeyHandlers.put(&quot;enableOverrideOfBuiltInFormatValidators&quot;, value -&gt; {</b>
<b class="nc">&nbsp;            if ((Boolean) value) {</b>
<b class="nc">&nbsp;                loaderBuilder.enableOverrideOfBuiltInFormatValidators();</b>
&nbsp;            }
&nbsp;        });
<b class="nc">&nbsp;        configKeyHandlers.put(&quot;primitiveParsing&quot;,</b>
<b class="nc">&nbsp;                value -&gt; validatorBuilder.primitiveValidationStrategy(PrimitiveValidationStrategy.valueOf((String) value)));</b>
<b class="nc">&nbsp;        fileByName(&quot;validator-config.json&quot;).map(file -&gt; streamAsJson(file)).ifPresent(configJson -&gt; {</b>
<b class="nc">&nbsp;            configKeyHandlers.entrySet()</b>
<b class="nc">&nbsp;                    .stream()</b>
<b class="nc">&nbsp;                    .filter(entry -&gt; configJson.has(entry.getKey()))</b>
<b class="nc">&nbsp;                    .forEach(entry -&gt; entry.getValue().accept(configJson.get(entry.getKey())));</b>
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    private FormatValidator createFormatValidator(Map.Entry&lt;String, Object&gt; entry) {
<b class="nc">&nbsp;        String formatClassName = (String) entry.getValue();</b>
&nbsp;        try {
<b class="nc">&nbsp;            Class&lt;? extends FormatValidator&gt; formatClass = (Class&lt;? extends FormatValidator&gt;) Class.forName(formatClassName);</b>
<b class="nc">&nbsp;            Constructor&lt;? extends FormatValidator&gt; ctor = formatClass.getConstructor();</b>
<b class="nc">&nbsp;            return ctor.newInstance();</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void stopJetty() {
<b class="nc">&nbsp;        if (servletSupport != null) {</b>
<b class="nc">&nbsp;            servletSupport.stop();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @ParameterizedTest
&nbsp;    @MethodSource(&quot;params&quot;)
&nbsp;    public void test(String issueDir, String testCaseName) {
<b class="nc">&nbsp;        this.issueDir = &quot;/&quot; + requireNonNull(issueDir, &quot;issueDir cannot be null&quot;);</b>
<b class="nc">&nbsp;        Assumptions.assumeFalse(testCaseName.startsWith(&quot;x&quot;), &quot;issue dir starts with &#39;x&#39; - ignoring&quot;);</b>
<b class="nc">&nbsp;        fileByName(&quot;remotes&quot;).ifPresent(unused -&gt; initJetty());</b>
&nbsp;        try {
<b class="nc">&nbsp;            Schema schema = loadSchema();</b>
<b class="nc">&nbsp;            fileByName(&quot;subject-valid.json&quot;).ifPresent(file -&gt; validate(file, schema, true));</b>
<b class="nc">&nbsp;            fileByName(&quot;subject-invalid.json&quot;).ifPresent(file -&gt; validate(file, schema, false));</b>
&nbsp;        } finally {
<b class="nc">&nbsp;            stopJetty();</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    private void validate(InputStream file, Schema schema, boolean shouldBeValid) {
<b class="nc">&nbsp;        ValidationException thrown = null;</b>
&nbsp;
<b class="nc">&nbsp;        Object subject = loadJsonFile(file);</b>
&nbsp;
&nbsp;        try {
<b class="nc">&nbsp;            Validator validator = validatorBuilder.build();</b>
<b class="nc">&nbsp;            validator.performValidation(schema, subject);</b>
<b class="nc">&nbsp;        } catch (ValidationException e) {</b>
<b class="nc">&nbsp;            thrown = e;</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        if (shouldBeValid &amp;&amp; thrown != null) {</b>
<b class="nc">&nbsp;            thrown.getAllMessages().forEach(System.out::println);</b>
<b class="nc">&nbsp;            StringBuilder failureBuilder = new StringBuilder(&quot;validation failed with: &quot; + thrown);</b>
<b class="nc">&nbsp;            for (ValidationException e : thrown.getCausingExceptions()) {</b>
<b class="nc">&nbsp;                failureBuilder.append(&quot;\n\t&quot;).append(e.getMessage());</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            fail(failureBuilder.toString());</b>
&nbsp;        }
<b class="nc">&nbsp;        if (!shouldBeValid &amp;&amp; thrown != null) {</b>
<b class="nc">&nbsp;            Optional&lt;InputStream&gt; expectedFile = fileByName(&quot;expected-exception.json&quot;);</b>
<b class="nc">&nbsp;            if (expectedFile.isPresent()) {</b>
<b class="nc">&nbsp;                checkExpectedValues(expectedFile.get(), thrown);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (!shouldBeValid &amp;&amp; thrown == null) {</b>
<b class="nc">&nbsp;            fail(&quot;did not throw ValidationException for invalid subject&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    // TODO - it would be nice to see this moved out of tests to the main
&nbsp;    // source so that it can be used as a convenience method by users also...
&nbsp;    private Object loadJsonFile(InputStream file) {
&nbsp;
<b class="nc">&nbsp;        Object subject = null;</b>
&nbsp;
&nbsp;        try {
<b class="nc">&nbsp;            JSONTokener jsonTok = new JSONTokener(IOUtils.toString(file));</b>
&nbsp;
&nbsp;            // Determine if we have a single JSON object or an array of them
<b class="nc">&nbsp;            Object jsonTest = jsonTok.nextValue();</b>
<b class="nc">&nbsp;            if (jsonTest instanceof JSONObject) {</b>
&nbsp;                // The message contains a single JSON object
<b class="nc">&nbsp;                subject = jsonTest;</b>
<b class="nc">&nbsp;            } else if (jsonTest instanceof JSONArray) {</b>
&nbsp;                // The message contains a JSON array
<b class="nc">&nbsp;                subject = jsonTest;</b>
&nbsp;            }
<b class="nc">&nbsp;        } catch (JSONException e) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;failed to parse subject json file&quot;, e);</b>
<b class="nc">&nbsp;        } catch (IOException e) {</b>
<b class="nc">&nbsp;            throw new UncheckedIOException(e);</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return subject;</b>
&nbsp;    }
&nbsp;
&nbsp;    private void sortCauses(JSONObject exc) {
<b class="nc">&nbsp;        JSONArray causes = exc.optJSONArray(&quot;causingExceptions&quot;);</b>
<b class="nc">&nbsp;        if (causes != null) {</b>
<b class="nc">&nbsp;            List&lt;JSONObject&gt; causesList = new ArrayList&lt;&gt;(causes.length());</b>
<b class="nc">&nbsp;            for (int i = 0; i &lt; causes.length(); ++i) {</b>
<b class="nc">&nbsp;                JSONObject item = causes.getJSONObject(i);</b>
<b class="nc">&nbsp;                sortCauses(item);</b>
<b class="nc">&nbsp;                causesList.add(item);</b>
&nbsp;            }
<b class="nc">&nbsp;            causesList.sort(Comparator.comparing(Object::toString));</b>
<b class="nc">&nbsp;            exc.put(&quot;causingExceptions&quot;, new JSONArray(causesList));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void checkExpectedValues(InputStream expectedExceptionsFile,
&nbsp;            ValidationException ve) {
<b class="nc">&nbsp;        JSONObject expected = (JSONObject) loadJsonFile(expectedExceptionsFile);</b>
<b class="nc">&nbsp;        sortCauses(expected);</b>
<b class="nc">&nbsp;        JSONObject actual = ve.toJSON();</b>
<b class="nc">&nbsp;        sortCauses(actual);</b>
<b class="nc">&nbsp;        if (!ObjectComparator.deepEquals(actual, expected)) {</b>
<b class="nc">&nbsp;            fail(&quot;Expected: &quot; + expected.toString(2) + &quot;but was: &quot; + actual.toString(2));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-11-01 17:20</div>
</div>
</body>
</html>
